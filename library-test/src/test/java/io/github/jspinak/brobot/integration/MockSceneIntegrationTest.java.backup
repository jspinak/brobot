package io.github.jspinak.brobot.integration;

import io.github.jspinak.brobot.action.Action;
import io.github.jspinak.brobot.action.ActionResult;
import io.github.jspinak.brobot.action.ObjectCollection;
import io.github.jspinak.brobot.action.basic.click.ClickOptions;
import io.github.jspinak.brobot.action.basic.find.PatternFindOptions;
import io.github.jspinak.brobot.action.basic.type.TypeOptions;
import io.github.jspinak.brobot.model.element.Location;
import io.github.jspinak.brobot.model.element.Region;
import io.github.jspinak.brobot.model.match.Match;
import io.github.jspinak.brobot.model.state.State;
import io.github.jspinak.brobot.model.state.StateImage;
import io.github.jspinak.brobot.test.BrobotTestBase;
import io.github.jspinak.brobot.tools.testing.mock.MockStatus;
import io.github.jspinak.brobot.tools.testing.mock.action.MockFind;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Nested;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import java.util.Arrays;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Integration tests for mock scene interactions.
 * Tests complex UI scenarios using mock objects to simulate real applications.
 */
@SpringBootTest
public class MockSceneIntegrationTest extends BrobotTestBase {

    @Autowired
    private Action action;

    @Autowired(required = false)
    private MockFind mockFind;
    
    @Autowired(required = false)
    private MockStatus mockStatus;

    private State loginScreen;
    private State mainMenu;
    private State settingsScreen;
    private StateImage usernameField;
    private StateImage passwordField;
    private StateImage loginButton;
    private StateImage settingsButton;
    private StateImage saveButton;

    @BeforeEach
    @Override
    public void setupTest() {
        super.setupTest();
        // Mock components are autowired, no need to instantiate
        setupMockStates();
    }

    private void setupMockStates() {
        // Create login screen state
        loginScreen = new State.Builder("LoginScreen").build();

        usernameField = new StateImage.Builder()
                .withName("usernameField")
                .withSearchRegion(new Region(100, 200, 200, 30))
                .build();

        passwordField = new StateImage.Builder()
                .withName("passwordField")
                .withSearchRegion(new Region(100, 250, 200, 30))
                .build();

        loginButton = new StateImage.Builder()
                .withName("loginButton")
                .withSearchRegion(new Region(150, 300, 100, 40))
                .build();

        loginScreen.getStateImages().addAll(Arrays.asList(usernameField, passwordField, loginButton));

        // Create main menu state
        mainMenu = new State.Builder("MainMenu").build();

        settingsButton = new StateImage.Builder()
                .withName("settingsButton")
                .withSearchRegion(new Region(500, 100, 80, 30))
                .build();

        mainMenu.getStateImages().add(settingsButton);

        // Create settings screen state
        settingsScreen = new State.Builder("SettingsScreen").build();

        saveButton = new StateImage.Builder()
                .withName("saveButton")
                .withSearchRegion(new Region(400, 500, 100, 40))
                .build();

        settingsScreen.getStateImages().add(saveButton);
    }

    private Match createMatch(StateImage stateImage, int x, int y) {
        return new Match.Builder()
                .setStateObject(stateImage)
                .setLocation(new Location(x, y))
                .setScore(0.95)
                .build();
    }

    @Nested
    class BasicMockInteractions {

        @Test
        public void testMockLoginWorkflow() {
            // Simulate finding and interacting with login form
            ObjectCollection loginForm = new ObjectCollection.Builder()
                    .withPatterns(usernameField.getStateImagePattern())
                    .build();

            ActionResult findUsername = action.find(loginForm);
            assertNotNull(findUsername, "Find result should not be null");
            
            // Click on username field
            if (findUsername.isSuccess() && !findUsername.getMatchList().isEmpty()) {
                ObjectCollection clickCollection = new ObjectCollection.Builder()
                        .withMatches(findUsername.getMatchList().get(0))
                        .build();
                ActionResult clickUsername = action.click(clickCollection);
                assertNotNull(clickUsername, "Click result should not be null");
            }

            // Type username
            ObjectCollection typeUsernameCollection = new ObjectCollection.Builder()
                    .withStrings("testuser")
                    .build();
            ActionResult typeUsername = action.type(typeUsernameCollection);
            assertNotNull(typeUsername, "Type result should not be null");

            // Find and interact with password field
            ObjectCollection passwordForm = new ObjectCollection.Builder()
                    .withPatterns(passwordField.getStateImagePattern())
                    .build();

            ActionResult findPassword = action.find(passwordForm);
            assertNotNull(findPassword, "Password find result should not be null");

            if (findPassword.isSuccess() && !findPassword.getMatchList().isEmpty()) {
                ObjectCollection clickPasswordCollection = new ObjectCollection.Builder()
                        .withMatches(findPassword.getMatchList().get(0))
                        .build();
                action.click(clickPasswordCollection);
            }

            // Type password
            ObjectCollection typePasswordCollection = new ObjectCollection.Builder()
                    .withStrings("testpass123")
                    .build();
            action.type(typePasswordCollection);

            // Click login button
            ObjectCollection loginButtonCollection = new ObjectCollection.Builder()
                    .withPatterns(loginButton.getStateImagePattern())
                    .build();
            ActionResult clickLogin = action.click(loginButtonCollection);
            assertNotNull(clickLogin, "Login click result should not be null");
        }

        @Test
        public void testNavigationBetweenScreens() {
            // Start on main menu, navigate to settings
            ObjectCollection menuCheck = new ObjectCollection.Builder()
                    .withPatterns(settingsButton.getStateImagePattern())
                    .build();
            
            // Check if we're on main menu
            ActionResult findSettings = action.find(menuCheck);
            assertNotNull(findSettings, "Settings find result should not be null");
            
            if (findSettings.isSuccess() && !findSettings.getMatchList().isEmpty()) {
                // Navigate to settings
                ObjectCollection clickSettingsCollection = new ObjectCollection.Builder()
                        .withMatches(findSettings.getMatchList().get(0))
                        .build();
                ActionResult clickSettings = action.click(clickSettingsCollection);
                assertNotNull(clickSettings, "Settings click result should not be null");
            }
            
            // Verify on settings screen
            ObjectCollection settingsCheck = new ObjectCollection.Builder()
                    .withPatterns(saveButton.getStateImagePattern())
                    .build();
            
            ActionResult findSave = action.find(settingsCheck);
            assertNotNull(findSave, "Save button find result should not be null");
        }
    }

    @Nested
    class ComplexMockScenarios {

        @Test
        public void testConditionalWorkflowBasedOnMockState() {
            // Check if we're on login screen
            ObjectCollection loginCheck = new ObjectCollection.Builder()
                    .withPatterns(loginButton.getStateImagePattern())
                    .build();
            ActionResult loginCheckResult = action.find(loginCheck);
            
            if (loginCheckResult != null && loginCheckResult.isSuccess()) {
                // We're on login screen - perform login
                ObjectCollection usernameCollection = new ObjectCollection.Builder()
                        .withPatterns(usernameField.getStateImagePattern())
                        .build();
                ActionResult findUsername = action.find(usernameCollection);
                
                if (findUsername.isSuccess() && !findUsername.getMatchList().isEmpty()) {
                    ObjectCollection clickUsernameCollection = new ObjectCollection.Builder()
                            .withMatches(findUsername.getMatchList().get(0))
                            .build();
                    action.click(clickUsernameCollection);
                }
                
                ObjectCollection typeUsernameCollection = new ObjectCollection.Builder()
                        .withStrings("admin")
                        .build();
                action.type(typeUsernameCollection);
                
                ObjectCollection passwordCollection = new ObjectCollection.Builder()
                        .withPatterns(passwordField.getStateImagePattern())
                        .build();
                ActionResult findPassword = action.find(passwordCollection);
                
                if (findPassword.isSuccess() && !findPassword.getMatchList().isEmpty()) {
                    ObjectCollection clickPasswordCollection = new ObjectCollection.Builder()
                            .withMatches(findPassword.getMatchList().get(0))
                            .build();
                    action.click(clickPasswordCollection);
                }
                
                ObjectCollection typePasswordCollection = new ObjectCollection.Builder()
                        .withStrings("admin123")
                        .build();
                action.type(typePasswordCollection);
                
                ObjectCollection loginCollection = new ObjectCollection.Builder()
                        .withPatterns(loginButton.getStateImagePattern())
                        .build();
                ActionResult loginResult = action.click(loginCollection);
                assertNotNull(loginResult, "Login result should not be null");
            }
            
            // Now check if we're on main menu
            ObjectCollection menuCollection = new ObjectCollection.Builder()
                    .withPatterns(settingsButton.getStateImagePattern())
                    .build();
            ActionResult menuCheck = action.find(menuCollection);
            
            assertNotNull(menuCheck, "Menu check result should not be null");
        }

        @Test
        public void testMockSceneWithMultipleStates() {
            // Test transitioning through multiple states
            State[] allStates = {loginScreen, mainMenu, settingsScreen};
            
            for (State state : allStates) {
                assertNotNull(state, "State should not be null");
                assertFalse(state.getStateImages().isEmpty(), "State should have images: " + state.getName());
                
                // Verify each state's images can be searched
                for (StateImage image : state.getStateImages()) {
                    ObjectCollection searchCollection = new ObjectCollection.Builder()
                            .withPatterns(image.getStateImagePattern())
                            .build();
                    
                    ActionResult result = action.find(searchCollection);
                    assertNotNull(result, "Should get result for " + image.getName());
                }
            }
        }

        @Test
        public void testMockSceneWithActionOptions() {
            // Test with various action options
            PatternFindOptions strictFind = new PatternFindOptions.Builder()
                    .setSimilarity(0.95)
                    .setSearchRegion(new Region(0, 0, 800, 600))
                    .build();
            
            ObjectCollection strictSearchCollection = new ObjectCollection.Builder()
                    .withPatterns(loginButton.getStateImagePattern())
                    .withActionConfig(strictFind)
                    .build();
            
            ActionResult strictResult = action.find(strictSearchCollection);
            assertNotNull(strictResult, "Strict find result should not be null");
            
            // Test click with options
            ClickOptions doubleClick = new ClickOptions.Builder()
                    .setDoubleClick(true)
                    .build();
            
            ObjectCollection doubleClickCollection = new ObjectCollection.Builder()
                    .withPatterns(settingsButton.getStateImagePattern())
                    .withActionConfig(doubleClick)
                    .build();
            
            ActionResult doubleClickResult = action.click(doubleClickCollection);
            assertNotNull(doubleClickResult, "Double click result should not be null");
            
            // Test type with options
            TypeOptions slowType = new TypeOptions.Builder()
                    .setModifiers("")
                    .build();
            
            ObjectCollection slowTypeCollection = new ObjectCollection.Builder()
                    .withStrings("slow typing test")
                    .withActionConfig(slowType)
                    .build();
            
            ActionResult typeResult = action.type(slowTypeCollection);
            assertNotNull(typeResult, "Type result should not be null");
        }
    }

    @Nested
    class MockSceneErrorHandling {

        @Test
        public void testHandleMissingMockElements() {
            // Create a state image that doesn't exist in any state
            StateImage nonExistentImage = new StateImage.Builder()
                    .withName("nonExistent")
                    .withSearchRegion(new Region(0, 0, 10, 10))
                    .build();
            
            ObjectCollection searchCollection = new ObjectCollection.Builder()
                    .withPatterns(nonExistentImage.getStateImagePattern())
                    .build();
            
            ActionResult result = action.find(searchCollection);
            assertNotNull(result, "Result should not be null even for non-existent elements");
            
            // In mock mode, operations should complete without throwing exceptions
            assertDoesNotThrow(() -> {
                action.click(searchCollection);
                action.type(new ObjectCollection.Builder().withStrings("test").build());
            });
        }

        @Test
        public void testRecoveryFromFailedMockActions() {
            // Simulate recovery from failed actions
            int maxRetries = 3;
            ActionResult successfulResult = null;
            
            for (int i = 0; i < maxRetries; i++) {
                ObjectCollection retryCollection = new ObjectCollection.Builder()
                        .withPatterns(loginButton.getStateImagePattern())
                        .build();
                
                ActionResult result = action.find(retryCollection);
                if (result != null) {
                    successfulResult = result;
                    break;
                }
                
                // Wait before retry (in mock mode this is instant)
                try {
                    Thread.sleep(100);
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }
            
            assertNotNull(successfulResult, "Should eventually get a result after retries");
        }
    }
}